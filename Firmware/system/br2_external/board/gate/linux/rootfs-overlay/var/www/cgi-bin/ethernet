#!/usr/bin/env python3
import sys
import os
import json
import socket
import fcntl
import struct
import re
import urllib.parse

# --- Config --- #
SOCKET_PATH = "/tmp/config-updater.sock"
ETH_INTERFACE = "eth0"
INTERFACES_FILE = "/etc/network/interfaces"

# --- Helpers --- #
def respond(status="200 OK", payload=None):
    if payload is None:
        payload = {}
    body = json.dumps(payload)
    sys.stdout.write(f"Status: {status}\r\n")
    sys.stdout.write("Content-Type: application/json\r\n")
    sys.stdout.write("Cache-Control: no-cache\r\n")
    sys.stdout.write("\r\n")
    sys.stdout.write(body)

def parse_post():
    length = int(os.environ.get("CONTENT_LENGTH", 0))
    raw = sys.stdin.read(length) if length > 0 else ""
    return dict(urllib.parse.parse_qsl(raw))

# --- Network info helpers --- #
def get_ip_netmask_broadcast(ifname):
    ip = netmask = broadcast = None
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        def ioctl(code):
            return socket.inet_ntoa(fcntl.ioctl(
                s.fileno(),
                code,
                struct.pack('256s', ifname.encode()[:15])
            )[20:24])
        ip = ioctl(0x8915)         # SIOCGIFADDR
        netmask = ioctl(0x891b)    # SIOCGIFNETMASK
        broadcast = ioctl(0x8919)  # SIOCGIFBRDADDR
    except:
        ip = netmask = broadcast = None
    return ip, netmask, broadcast

def get_ip_method(ifname):
    try:
        with open(INTERFACES_FILE) as f:
            for line in f:
                m = re.match(rf"iface\s+{re.escape(ifname)}\s+inet\s+(\w+)", line)
                if m:
                    return m.group(1).lower()
    except:
        return None
    return None

def get_gateway(ifname, method):
    if method == "dhcp":
        try:
            with open("/proc/net/route") as f:
                for line in f:
                    parts = line.strip().split()
                    if len(parts) < 11 or parts[0] != ifname:
                        continue
                    dest, gw_hex, flags = parts[1], parts[2], parts[3]
                    if dest == "00000000" and int(flags, 16) & 2:
                        gw_int = int(gw_hex, 16)
                        return ".".join(str((gw_int >> (8 * i)) & 0xFF) for i in range(4))
        except:
            return None
    else:
        try:
            iface_section = False
            with open(INTERFACES_FILE) as f:
                for line in f:
                    line = line.strip()
                    if re.match(rf"iface\s+{re.escape(ifname)}\s+inet\s+\w+", line):
                        iface_section = True
                        continue
                    if iface_section:
                        m = re.match(r"gateway\s+(.+)", line)
                        if m and m.group(1).strip():
                            return m.group(1).strip()
                        if line.startswith("iface "):
                            break
        except:
            return None
    return None

def get_dns():
    dns1 = dns2 = None
    try:
        if os.path.exists("/etc/resolv.conf"):
            d = []
            with open("/etc/resolv.conf") as f:
                for line in f:
                    line = line.split("#")[0].strip()
                    if line.startswith("nameserver"):
                        parts = line.split()
                        if len(parts) >= 2:
                            d.append(parts[1])
            if len(d) >= 2: return d[0], d[1]
            if len(d) == 1: return d[0], None
    except:
        return None, None
    return dns1, dns2

def get_link_info(ifname):
    up = False
    try:
        path = f"/sys/class/net/{ifname}/operstate"
        if os.path.exists(path):
            with open(path) as f:
                up = f.read().strip() == "up"
    except:
        up = False
    return {"up": up, "speed": 100, "duplex": "full"}

# --- Apply configuration --- #
def apply_config(form):
    config = {
        "ip_config": form.get("ip_config", "dhcp"),
        "ip": form.get("ip") or None,
        "netmask": form.get("netmask") or None,
        "gateway": form.get("gateway") or None,
        "broadcast": form.get("broadcast") or None,
        "dns1": form.get("dns1") or None,
        "dns2": form.get("dns2") or None
    }

    # Validate static config
    if config['ip_config'] == "static":
        if not config["ip"] or not config["netmask"]:
            respond("400 Bad Request", {"error":"Static config requires ip and netmask"})
            return

    payload = {
        "interface": ETH_INTERFACE,
        "action": "apply_eth",
        "config": config
    }

    if not os.path.exists(SOCKET_PATH):
        respond("500 Internal Server Error", {"error":"apply daemon unreachable"})
        return

    try:
        with socket.socket(socket.AF_UNIX, socket.SOCK_STREAM) as s:
            s.connect(SOCKET_PATH)
            s.sendall(json.dumps(payload).encode("utf-8"))
            data = s.recv(65536)
            result = json.loads(data.decode("utf-8"))
            if result.get("status") == "ok":
                respond("200 OK", result)
            else:
                respond("500 Internal Server Error", result)
    except Exception as e:
        respond("500 Internal Server Error", {"error": str(e)})

# --- Gather info --- #
def gather_info():
    method = get_ip_method(ETH_INTERFACE)
    ip, netmask, broadcast = get_ip_netmask_broadcast(ETH_INTERFACE)
    gateway = get_gateway(ETH_INTERFACE, method)
    dns1, dns2 = get_dns()
    link = get_link_info(ETH_INTERFACE)

    data = {
        "ip_config": method if method else None,
        "address": ip if ip else None,
        "netmask": netmask if netmask else None,
        "broadcast": broadcast if broadcast else None,
        "gateway": gateway if gateway else None,
        "dns1": dns1 if dns1 else None,
        "dns2": dns2 if dns2 else None,
        "link": link
    }
    respond("200 OK", data)

# --- Main --- #
def main():
    try:
        path = os.environ.get("PATH_INFO", "/").lower()
        if path.endswith("/apply"):
            form = parse_post()
            apply_config(form)
        elif path.endswith("/info"):
            gather_info()
        else:
            respond("404 Not Found", {"error": f"Unknown endpoint '{path}'"})
    except Exception as e:
        respond("500 Internal Server Error", {"error": str(e)})

if __name__ == "__main__":
    main()
